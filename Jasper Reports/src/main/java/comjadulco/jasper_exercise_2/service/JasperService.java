 package comjadulco.jasper_exercise_2.service;


import comjadulco.jasper_exercise_2.repository.InmateRepository;
import net.sf.jasperreports.engine.*;
import net.sf.jasperreports.engine.data.JRBeanCollectionDataSource;
import net.sf.jasperreports.engine.export.JRCsvExporter;
import net.sf.jasperreports.engine.export.ooxml.JRDocxExporter;
import net.sf.jasperreports.export.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;
import java.io.*;
import java.util.HashMap;
import java.util.Map;

@Service
public class JasperService {


    @Autowired
    private InmateRepository inmateRepository;

    public void generateReport(String fileName, HttpServletResponse response, String exportType) throws IOException, JRException {

        JRBeanCollectionDataSource dataSource = null;
        InputStream inputStream = null;

        try {

            if (fileName.equalsIgnoreCase("female_inmates_report")) {
                inputStream = this.getClass().getResourceAsStream("/jrxml/female_inmates_report.jrxml");
                dataSource = new JRBeanCollectionDataSource(inmateRepository.findBySex(4L));

            } else if (fileName.equalsIgnoreCase("foreign_inmates_report")) {
                inputStream = this.getClass().getResourceAsStream("/jrxml/foreign_inmates_report.jrxml");
                dataSource = new JRBeanCollectionDataSource(inmateRepository.findAllForeigners());
            }

            export(exportType, fileName, inputStream, dataSource);

        } catch ( JRException e) {
            throw(e);
        }  finally {
            if (inputStream != null) {
                inputStream.close();
            }
        }
    }

    private void export(String exportType, String fileName, InputStream inputStream, JRBeanCollectionDataSource dataSource) throws JRException {
        try {
            Map<String, Object> parameters = new HashMap<>();

            JasperReport jasperReport = JasperCompileManager.compileReport(inputStream);

            JasperPrint jasperPrint = JasperFillManager.fillReport(jasperReport, parameters, dataSource);


            if (exportType.equalsIgnoreCase("pdf")) {
                exportToPdf(fileName, jasperPrint);

            } else if (exportType.equalsIgnoreCase("docx")) {
                exportToDocx(fileName, jasperPrint);

            } else if (exportType.equalsIgnoreCase("csv")) {
                exportToCsv(fileName, jasperPrint);
            }

        }   catch ( JRException e) {
            throw(e);
        }
    }


    public void exportToPdf(String fileName, JasperPrint jasperPrint) throws JRException {
        try {
            JasperExportManager.exportReportToPdfFile(jasperPrint, "output files/" + fileName + ".pdf");
        } catch ( JRException e) {
            throw(e);
        }
    }

    public void exportToDocx(String fileName, JasperPrint jasperPrint) throws JRException {
        try {
            JRDocxExporter export = new JRDocxExporter();
            export.setExporterInput(new SimpleExporterInput(jasperPrint));
            export.setExporterOutput(new SimpleOutputStreamExporterOutput(new File("output files/" + fileName + ".docx")));

            SimpleDocxReportConfiguration config = new SimpleDocxReportConfiguration();

            export.setConfiguration(config);
            export.exportReport();
        } catch ( JRException e) {
            throw(e);
        }
    }

    public void exportToCsv(String fileName, JasperPrint jasperPrint) throws JRException {
        try {
            JRCsvExporter export = new JRCsvExporter();
            export.setExporterInput(new SimpleExporterInput(jasperPrint));
            export.setExporterOutput(new SimpleWriterExporterOutput("output files/" + fileName + ".csv"));

            SimpleCsvExporterConfiguration config = new SimpleCsvExporterConfiguration();

            export.setConfiguration(config);
            export.exportReport();
        } catch ( JRException e) {
            throw(e);
        }
    }
}










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































